<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Phone Compare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <style>
    html,body{height:100%;background:#fff;margin:0}
    model-viewer{width:100%;height:70vh;display:block;background:transparent}
    .overlay-mode{position:relative;height:70vh}
    .overlay-mode .viewer-box{position:absolute;top:0;left:0;width:100%;height:100%;padding:0}
    .overlay-mode h6{display:none}
    .overlay-mode #box1{z-index:2}
    .overlay-mode #box2{z-index:1;pointer-events:none}
  </style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark sticky-top border-bottom border-secondary">
  <div class="container-fluid d-flex justify-content-between align-items-center flex-nowrap py-1">
    <button class="btn btn-sm text-white" type="button"
            data-bs-toggle="offcanvas" data-bs-target="#mainMenu" aria-controls="mainMenu"
            aria-label="Open menu">
      <span class="navbar-toggler-icon"></span>
    </button>
  </div>
</nav>

<div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mainMenu" aria-labelledby="mainMenuLabel" data-bs-theme="dark">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mainMenuLabel">Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <nav class="nav flex-column">
      <a class="nav-link text-primary" href="index.html">Home</a>
    </nav>
  </div>
</div>

  <!-- Add optional per-model starting rotation with "startOrbit" (e.g., "180deg auto auto") -->
  <script type="application/json" id="phones-config">
  {
    "models": [
      { "name": "iPhone Pro",     "src": "models/iphone_13_pro.glb",      "startOrbit": "180deg auto auto" },
      { "name": "iPhone Pro Max", "src": "models/iphone_13_pro_max.glb",  "startOrbit": "180deg auto auto" }
    ]
  }
  </script>

  <div class="container py-4">
    <div class="d-flex justify-content-end mb-3">
      <button id="stackBtn" class="btn btn-primary" type="button">Stack views</button>
    </div>
    <div id="viewerWrapper" class="row g-4">
      <div id="box1" class="col-12 col-md-6 viewer-box">
        <h6 class="mb-2 text-center" id="title1">—</h6>
        <model-viewer id="viewer1"
          camera-controls
          bounds="tight"
          touch-action="pan-y"
          interaction-prompt="none">
        </model-viewer>
      </div>
      <div id="box2" class="col-12 col-md-6 viewer-box">
        <h6 class="mb-2 text-center" id="title2">—</h6>
        <model-viewer id="viewer2"
          camera-controls
          bounds="tight"
          touch-action="pan-y"
          interaction-prompt="none">
        </model-viewer>
      </div>
    </div>
  </div>

  <script>
    const { models } = JSON.parse(document.getElementById('phones-config').textContent);

    const v1 = document.getElementById('viewer1');
    const v2 = document.getElementById('viewer2');
    const t1 = document.getElementById('title1');
    const t2 = document.getElementById('title2');

    // Names & sources
    t1.textContent = models[0].name; v1.src = models[0].src;
    t2.textContent = models[1].name; v2.src = models[1].src;

    // Apply per-model starting rotation if provided (before load is fine)
    if (models[0].startOrbit) v1.setAttribute('camera-orbit', models[0].startOrbit);
    if (models[1].startOrbit) v2.setAttribute('camera-orbit', models[1].startOrbit);

    // Helpers
    const whenLoaded = v => new Promise(res => v.addEventListener('load', res, { once: true }));
    let syncing = false;
    const EPS = 1e-4;
    const nearlyEqual = (a,b) => Math.abs(a-b) < EPS;

    // Sync θ/φ (rotation) only; keep each viewer’s own radius/FOV
    function syncRotation(from, to) {
      if (syncing) return;
      const of = from.getCameraOrbit?.();
      const ot = to.getCameraOrbit?.();
      if (!of || !ot) return;
      if (nearlyEqual(of.theta, ot.theta) && nearlyEqual(of.phi, ot.phi)) return;

      syncing = true;
      requestAnimationFrame(() => {
        to.cameraOrbit = `${of.theta}rad ${of.phi}rad ${ot.radius}m`;
        to.jumpCameraToGoal?.();
        syncing = false;
      });
    }

    (async () => {
      await customElements.whenDefined('model-viewer');
      await Promise.all([whenLoaded(v1), whenLoaded(v2)]);
      // Start with your configured orientations; then allow bi-directional sync
      v1.addEventListener('camera-change', () => syncRotation(v1, v2));
      v2.addEventListener('camera-change', () => syncRotation(v2, v1));
    })();

    // Stack/unstack UI
    const wrapper = document.getElementById('viewerWrapper');
    const btn = document.getElementById('stackBtn');
    let stacked = false;
    btn.addEventListener('click', () => {
      stacked = !stacked;
      if (stacked) {
        wrapper.classList.add('overlay-mode');
        wrapper.classList.remove('row','g-4');
        btn.textContent = 'Unstack views';
      } else {
        wrapper.classList.remove('overlay-mode');
        wrapper.classList.add('row','g-4');
        btn.textContent = 'Stack views';
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
